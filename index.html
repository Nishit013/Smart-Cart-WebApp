<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üõí Smart Cart Pro</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #121212;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
 
    .header {
      width: 95%;
      max-width: 500px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
 
    .shop-name {
      font-size: 1em;
      color: #00e5ff;
    }
 
    .time, .date {
      font-size: 0.9em;
      color: #ccc;
    }
 
    h1 {
      font-family: 'Verdana', sans-serif;
      font-size: 2.2em;
      margin-bottom: 10px;
      color: #00e5ff;
      text-align: center;
    }
 
    .section {
      background-color: #1e1e1e;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      width: 95%;
      max-width: 500px;
    }
 
    .section h3 {
      margin-top: 0;
      color: #00bcd4;
    }
 
    .btn {
      padding: 10px 20px;
      font-size: 1em;
      margin: 8px 5px;
      border: none;
      background-color: #00bcd4;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      width: 90%;
      max-width: 300px;
    }
 
    .btn:hover {
      background-color: #0097a7;
    }
 
    .button-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      flex-direction: column;
      align-items: center;
    }
 
    input[type="tel"] {
      padding: 10px;
      font-size: 1em;
      width: 90%;
      max-width: 300px;
      border-radius: 6px;
      border: 1px solid #555;
      margin: 15px 0 10px 0;
      background: #2b2b2b;
      color: white;
    }
 
    #checkoutBtn:disabled {
      opacity: 0.5;
      pointer-events: none;
    }
 
    #cartItemsList {
      max-height: 400px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }
 
    footer {
      margin-top: 30px;
      font-size: 0.8em;
      color: #aaa;
      text-align: center;
    }
 
    footer a {
      color: #00bcd4;
      margin: 0 5px;
      text-decoration: none;
    }
 
    footer a:hover {
      text-decoration: underline;
    }
 
    .qty-btn, .remove-btn {
      padding: 5px 10px;
      margin: 2px;
      font-size: 0.9em;
      border-radius: 5px;
      border: none;
      color: white;
    }
 
    .qty-btn {
      background-color: #555;
    }
 
    .remove-btn {
      background-color: red;
    }
 
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 9999;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
 
    #loading {
      display: none;
      color: #00e5ff;
      margin: 10px 0;
      font-style: italic;
    }

    .coupon-section {
  background: #1e1e1e;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  color: #fff;
}

.coupon-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 5px;
}

.input-field {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #2a2a2a;
  color: #fff;
  flex: 1;
}

.input-field:focus {
  border-color: #00bcd4;
  outline: none;
}

.btn {
  padding: 8px 20px;
  border-radius: 6px;
  border: none;
  background: #00bcd4;
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.btn:hover {
  background: #0097a7;
}

.cart-summary {
  background: #2a2a2a;
  padding: 15px;
  border-radius: 10px;
  color: #fff;
  font-size: 16px;
}

.cart-summary p {
  margin: 5px 0;
}

.cart-summary strong {
  font-size: 18px;
  color: #00e676;
}


  </style>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Your Firebase configuration object
  const firebaseConfig = {
    apiKey: "AIzaSyCTLNpJB02VZ_-kjZaL_y-cHX74U4hzwvE",
    authDomain: "smartcartpro-367bf.firebaseapp.com",
    databaseURL: "https://smartcartpro-367bf-default-rtdb.firebaseio.com",
    projectId: "smartcartpro-367bf",
    storageBucket: "smartcartpro-367bf.appspot.com",
    messagingSenderId: "823504170326",
    appId: "1:823504170326:web:0b9e24b85e8f40ba8dfaf7"
  };
 
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database(); // This lets you use db.ref(...) later
</script>
 
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="header">
    <div class="shop-name"><strong>by SmartCart</strong></div>
    <div class="time">
      <div id="timeDisplay"></div>
      <div class="date" id="dateDisplay"></div>
    </div>
  </div>
 
  <h1>üõí Smart Cart Pro</h1>
 
  <div class="section">
    <h3><strong>üõí Cart Number:</strong> <span style="font-weight:bold" id="cartNumber">#</span></h3>
  </div>
 
  <div class="section">
    <h3>üîó Cart Connection Status</h3>
    <div id="connectionStatus">‚ùå Not connected.</div>
    <div class="button-row">
      <button class="btn" onclick="connectToCart()">Connect to Cart</button>
      <button class="btn" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>
 
  <div class="section">
    <h3>üì¶ Scanned Products</h3>
    <div id="cartItemsList">No items scanned.</div>
  </div>
 
  <div class="section">
    <h3>üí∞ Total of Scanned Products</h3>
    <div id="totalPrice">‚Çπ0</div>
  </div>
 


  <div id="couponSection" class="coupon-section">
  <label for="couponDropdown">üéÅ Select Coupon:</label>
  <div class="coupon-row">
    <select id="couponDropdown" class="input-field">
      <option value="">-- Choose a coupon --</option>
    </select>
    <button id="applyCoupon" class="btn">Apply</button>
  </div>
</div>

<div class="cart-summary">
  <p>Cart Total: <span id="cartTotal">‚Çπ0.00</span></p>
  <p>Discount: <span id="discountAmount">‚Çπ0.00</span></p>
  <p><strong>Final Total: <span id="finalTotal">‚Çπ0.00</span></strong></p>
</div>




  <label for="phone">üì± Enter Your Phone Number:</label>
  <input type="tel" id="phone" placeholder="10-digit phone number" oninput="validatePhone()" />
  <div id="loading">‚åõ Processing payment...</div>
  <button class="btn" id="checkoutBtn" onclick="checkout()" disabled>üí≥ Checkout & Generate Bill</button>
 
  <div class="section">
    üí≥ <strong>Payment Gateway:</strong> Razorpay integrated | PDF + WhatsApp Bill
  </div>
 
  <footer>
    <a href="privacy-policy.html">Privacy Policy</a> |
    <a href="terms-and-conditions.html">Terms & Conditions</a> |
    <a href="cancellation-refund.html">Cancellation & Refund</a> |
    <a href="shipping-delivery.html">Shipping & Delivery</a> |
    <a href="contact-us.html">Contact Us</a>
  </footer>
 
  <div id="toast"></div>
 
  <script>
    let cartItems = [];
    let bleCharacteristic;
 
    
 
    const urlParams = new URLSearchParams(window.location.search);
const cartId = urlParams.get("id"); // ‚úÖ Only QR-based cart, no default
const bleName = cartId ? "ESP32-" + cartId.toUpperCase() : null;

function loadCartFromFirebase() {
  if (!cartId) {
    console.warn("No cartId found in URL. No cart data will be loaded.");
    return; // Stop if no QR ID
  }

  db.ref("carts/" + cartId).once("value").then(snapshot => {
    if (snapshot.exists()) {
      const cartData = snapshot.val();
      cartItems = cartData.items || [];
      renderCart();
    }
  }).catch(err => {
    console.error("Error loading cart:", err);
  });
}

 
    document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("cartNumber").textContent = "#" + cartId;
  loadCartFromFirebase();
});

 
    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 3000);
    }
 
    async function connectToCart() {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: bleName }],
          optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
        });
 
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
        bleCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
 
        await bleCharacteristic.startNotifications();
        bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);
 
        document.getElementById("connectionStatus").textContent = `‚úÖ Connected to ${bleName}`;
        showToast(`‚úÖ Connected to ${bleName}`);
      } catch (error) {
        document.getElementById("connectionStatus").textContent = "‚ùå Connection failed: " + error.message;
        showToast("‚ùå Connection failed");
        clearCart();
      }
    }
 
    function handleData(event) {
  const barcode = new TextDecoder().decode(event.target.value).trim();

  db.ref("products/" + barcode).once("value").then(snap => {
    if (snap.exists()) {
      const product = snap.val();
      const existing = cartItems.find(item => item.barcode === barcode);
      if (existing) {
        existing.qty += 1;
      } else {
        cartItems.push({ ...product, barcode, qty: 1 });
      }
      renderCart();
      syncCartToFirebase();  // (optional, if you want to sync)
    } else {
      showToast("‚ùå Product not found in database!");
    }
  }).catch(err => {
    console.error("Error fetching product:", err);
    showToast("‚ö†Ô∏è Error fetching product data.");
  });
}

 
    function renderCart() {
  const container = document.getElementById("cartItemsList");
  const totalContainer = document.getElementById("totalPrice");
  if (cartItems.length === 0) {
    container.textContent = "No items scanned.";
    totalContainer.textContent = "‚Çπ0";
    updateCartTotalForCoupons(); // update coupon totals
    return;
  }

  let html = "<ul style='padding-left: 15px;'>";
  let total = 0;
  cartItems.forEach((item, i) => {
    const subtotal = item.price * item.qty;
    html += `<li>
      <span>${i + 1}. ${item.name} - ‚Çπ${item.price} = ‚Çπ${subtotal}</span>

      <span style="display: flex; align-items: center; gap: 4px; margin-top: 6px;">
       <button class="qty-btn" onclick="changeQty(${i}, -1)">‚ûñ</button>
       <span style="padding: 4px 8px; background: #333; border-radius: 5px;">${item.qty}</span>
       <button class="qty-btn" onclick="changeQty(${i}, 1)">‚ûï</button>
       <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
    </span>

    </li>`;
    total += subtotal;
  });
  html += "</ul>";
  container.innerHTML = html;

  totalContainer.textContent = `‚Çπ${total}`;
  updateCartTotalForCoupons(); // ‚úÖ update coupon totals after calculating total
}



    function changeQty(index, change) {
      cartItems[index].qty += change;
      if (cartItems[index].qty <= 0) {
        cartItems.splice(index, 1);
      }
      renderCart();
      syncCartToFirebase();
    }
 
    function removeItem(index) {
      cartItems.splice(index, 1);
      renderCart();
      syncCartToFirebase();
    }
 
    function clearCart(skipFirebase = false) {
  cartItems = [];
  document.getElementById("cartItemsList").textContent = "No items scanned.";
  document.getElementById("totalPrice").textContent = "‚Çπ0";
  if (!skipFirebase) {
    syncCartToFirebase(); // Only clear in Firebase if not paid
  }
}
 
    function validatePhone() {
      const phone = document.getElementById("phone").value;
      const button = document.getElementById("checkoutBtn");
      button.disabled = !/^\d{10}$/.test(phone);
    }
    function syncCartToFirebase() {
  const total = cartItems.reduce((sum, item) => sum + item.price * item.qty, 0);
  const cartData = {
    cartId,
    items: cartItems,
    total,
    paymentStatus: "Pending",
    lastUpdated: new Date().toISOString()
  };
  db.ref('carts/' + cartId).set(cartData);
}
 
    async function generatePDF(cartItems, total, discount, finalAmount) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
 
  // Header
  doc.setFontSize(14);
  doc.text("Smart Cart Pro", 20, 20);
  doc.setFontSize(10);
  doc.text("Campus Store - Hall 1, Block B, Tech Street", 20, 26);
  doc.text("GSTIN: 24XXXXXXX1Z9", 20, 31);
  doc.text("TAX INVOICE", 150, 20);
 
  // Date and time
  const now = new Date();
  doc.text(`Date: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`, 150, 26);
 
  // Line
  doc.setLineWidth(0.1);
  doc.line(20, 34, 190, 34);
 
  // Table header
  doc.setFontSize(11);
  let y = 40;
  doc.text("Item", 20, y);
  doc.text("Price", 90, y);
  doc.text("Qty", 120, y);
  doc.text("Amount", 150, y);
  y += 6;
 
  doc.setLineWidth(0.05);
  cartItems.forEach(item => {
    const subtotal = item.price * item.qty;
    doc.text(item.name, 20, y);
    doc.text(`‚Çπ${item.price.toFixed(2)}`, 90, y);
    doc.text(`${item.qty}`, 120, y);
    doc.text(`‚Çπ${subtotal.toFixed(2)}`, 150, y);
    y += 6;
  });
 
  // Line before total
  y += 4;
  doc.line(20, y, 190, y);
  y += 6;
 
  // Subtotal
  doc.setFontSize(11);
  doc.text("Subtotal:", 120, y);
  doc.text(`‚Çπ${total.toFixed(2)}`, 170, y, { align: "right" });
  y += 6;

  // Discount (only if applied)
  if (discount > 0) {
    doc.setTextColor(200, 0, 0); // red for discount
    doc.text("Discount:", 120, y);
    doc.text(`-‚Çπ${discount.toFixed(2)}`, 170, y, { align: "right" });
    doc.setTextColor(0, 0, 0);
    y += 6;
  }

  // Final total
  doc.setFontSize(12);
  doc.setFont(undefined, "bold");
  doc.text("Final Invoice Amount:", 120, y);
  doc.text(`‚Çπ${finalAmount.toFixed(2)}`, 170, y, { align: "right" });
  doc.setFont(undefined, "normal");
  y += 10;
 
  // Footer notes
  doc.setFontSize(9);
  doc.text("This is a computer-generated invoice and doesn't require a signature.", 20, y);
  y += 5;
  doc.text("Thank you for shopping with Smart Cart Pro!", 20, y);
 
  // Save the file
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
  doc.save(`SmartCart_Receipt_${timestamp}.pdf`);
}

 
 
    function sendWhatsAppBill(summary, phoneNumber) {
      const customerNumber = "91" + phoneNumber;
      const message = encodeURIComponent(" Smart Cart Bill\n\n" + summary);
      const url = `https://wa.me/${customerNumber}?text=${message}`;
      window.open(url, "_blank");
    }
 
    function checkout() {
      const phone = document.getElementById("phone").value.trim();
      if (!/^\d{10}$/.test(phone)) return showToast("üìµ Invalid phone number.");
      if (cartItems.length === 0) return showToast("‚ùå Cart is empty. Please scan some items.");
 
      document.getElementById("checkoutBtn").disabled = true;
      document.getElementById("loading").style.display = "block";
 
      let summary = '';
      let total = 0;
      cartItems.forEach((item, i) => {
        const subtotal = item.price * item.qty;
        summary += `${i + 1}. ${item.name} - ‚Çπ${item.price} √ó ${item.qty} = ‚Çπ${subtotal}\n`;
        total += subtotal;
      });
      summary += `\nTotal: ‚Çπ${total}`;


      let discount = parseFloat(discountAmountEl.textContent.replace(/[‚Çπ,]/g, "")) || 0;
let finalAmount = total - discount;
 


 
      const options = {
  key: "rzp_live_es0XjKaI61byUK",

  amount: finalAmount * 100, // use discounted total

  currency: "INR",
  name: "Smart Cart Pro",
  description: "Smart Cart Payment",
  handler: function (response) {
  showToast("‚úÖ Payment Successful");
  // Update summary with discount
let finalSummary = summary;
if (discount > 0) {
  finalSummary += `\nDiscount: -‚Çπ${discount.toFixed(2)}\n`;
  finalSummary += `Final Amount: ‚Çπ${finalAmount.toFixed(2)}`;
}

// Generate PDF & WhatsApp with final amount
// Generate PDF & WhatsApp with final amount
generatePDF(cartItems, total, discount, finalAmount);
sendWhatsAppBill(finalSummary, phone);


// Store discounted bill in Firebase
const paidCartData = {
  cartId,
  items: cartItems,
  total,          // original total before discount
  discount,       // discount applied
  finalAmount,    // actual paid amount
  phone,
  paymentTime: new Date().toISOString(),
  bill: { summary: finalSummary }
};

const paidKey = cartId + "_" + Date.now();
db.ref('paidCarts/' + paidKey).set(paidCartData).then(() => {
  db.ref('carts/' + cartId).update({
    paymentStatus: "Paid",
    finalAmount: finalAmount,
    discount: discount,
    bill: { summary: finalSummary }
  });


      clearCart(true); // Only clears UI
      document.getElementById("checkoutBtn").disabled = false;
      document.getElementById("loading").style.display = "none";
    }).catch((error) => {
      showToast("‚ö†Ô∏è Error storing bill in Firebase.");
      console.error(error);
      document.getElementById("checkoutBtn").disabled = false;
      document.getElementById("loading").style.display = "none";
    });
  },
  prefill: { contact: phone },
  theme: { color: "#00bcd4" }
};

const rzp1 = new Razorpay(options);
rzp1.open();

 
      rzp1.on('payment.failed', function (response) {
        showToast("‚ùå Payment Failed: " + response.error.description);
        document.getElementById("checkoutBtn").disabled = false;
        document.getElementById("loading").style.display = "none";
      });
    }
 
    setInterval(() => {
      const now = new Date();
      document.getElementById("timeDisplay").textContent =
        now.getHours().toString().padStart(2, '0') + ":" +
        now.getMinutes().toString().padStart(2, '0');
      document.getElementById("dateDisplay").textContent = now.toLocaleDateString();
    }, 1000);
  </script>
  <script>
  const couponDropdown = document.getElementById("couponDropdown");
  const applyCouponBtn = document.getElementById("applyCoupon");
  const cartTotalEl = document.getElementById("cartTotal");
  const discountAmountEl = document.getElementById("discountAmount");
  const finalTotalEl = document.getElementById("finalTotal");

  let cartTotal = 0;

function updateCartTotalForCoupons() {
  cartTotal = cartItems.reduce((sum, item) => sum + item.price * item.qty, 0);
  cartTotalEl.textContent = `‚Çπ${cartTotal.toFixed(2)}`;
  discountAmountEl.textContent = `‚Çπ0.00`;
  finalTotalEl.textContent = `‚Çπ${cartTotal.toFixed(2)}`;
}


// Call this at the end of renderCart()


// Dropdown population remains the same
db.ref("offers").on("value", function(snapshot) {
  couponDropdown.innerHTML = '<option value="">-- Choose a coupon --</option>';
  const today = new Date();
  snapshot.forEach(childSnapshot => {
    const offer = childSnapshot.val();
    const start = new Date(offer.startDate);
    const end = new Date(offer.endDate);

    if (offer.status === "active" && today >= start && today <= end) {
      const option = document.createElement("option");
      option.value = childSnapshot.key;
      const discountText = offer.discountType === 'percentage' 
        ? `${offer.discountValue}%` 
        : `‚Çπ${offer.discountValue}`;
      option.textContent = `${offer.couponCode || offer.code} - ${discountText} off`;
      couponDropdown.appendChild(option);
    }
  });
});


// Apply coupon
applyCouponBtn.addEventListener("click", function() {
  const couponId = couponDropdown.value;
  if (!couponId) return alert("Please select a coupon.");

  db.ref("offers/" + couponId).once("value").then(snapshot => {
    const offer = snapshot.val();
    if (!offer) return alert("Coupon not found.");

    if (cartTotal < offer.minPurchase) {
      return alert(`Minimum purchase of ‚Çπ${offer.minPurchase} required.`);
    }

    let discount = 0;
    if (offer.discountType === "flat") discount = offer.discountValue;
    else if (offer.discountType === "percentage") {
      discount = (cartTotal * offer.discountValue) / 100;
      if (offer.maxDiscount > 0) discount = Math.min(discount, offer.maxDiscount);
    }

    discount = Math.min(discount, cartTotal);

    // Show discount with ‚Çπ symbol
    discountAmountEl.textContent = `‚Çπ${discount.toFixed(2)}`;
    finalTotalEl.textContent = `‚Çπ${(cartTotal - discount).toFixed(2)}`;

    // Animation effect
    discountAmountEl.style.transition = "0.3s";
    finalTotalEl.style.transition = "0.3s";
    discountAmountEl.style.color = "#00e676";
    finalTotalEl.style.color = "#00e676";
    setTimeout(() => {
      discountAmountEl.style.color = "#fff";
      finalTotalEl.style.color = "#fff";
    }, 500);

    alert(`Coupon "${offer.couponCode || offer.code}" applied!`);
  });
});

</script>
</body>
</html>